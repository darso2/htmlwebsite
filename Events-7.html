<!doctype html>
<html>
	<head>
		<title>Events 1 </title>
		<script src="https://code.jquery.com/jquery-3.2.1.js"></script>
		<link type="text/css" rel="stylesheet" href="eventstyles.css"/>
	</head>
	<body>
		<div id="WorkArea" class="clickable">
			<h5 class="clickable"> Work Area </h5>
			<hr />
			<input type="button" class="clickable" value="Click here" />
			<p class="clickable">
			Click me too! </p>
			<p class="clickable">This is some text with an embedded <span class="clickable"> span </span> 
			element </p>
		</div>
		<div id="Messages">
			<h5> Messages</h5>
			<hr/>
		</div>
	</body>
	<script>
	$(function(){
		var showEventMessage = function(options)
			{	options = $.extend(
				{	eventType: "CLICK",
					eventTarget: this,
					suffix: '<br/>'
				}, options);
				var message = options.eventType + ": " +
							  (options.eventTarget.nodeName || "unknown") + options.suffix;
				$("#Messages").append(message);
			}
			internalObject = { records: [], maxCount: 5},
			notifyObject = $({nodeName: 'INTERNAL'})
			loadRecord = function()
			{	var id = internalObject.records.length;
				if (id < internalObject.maxCount)
				{	internalObject.records.push(
					{ 'description': 'Record ID ' +id, value: Math.floor(Math.random() * 5000)
				});
				setTimeout(loadRecord, Math.floor(Math.random() * 1000));
				}
				else
					$(notifyObject).trigger('recordsloaded', internalObject); //pass this 
			}
			
		$(".clickable")
		// added internal object so that it can be referenced externally
			.on('click',internalObject, function(event){
				var $this = $(this),
				clickCount = ($this.data('clickcount') || 0 ) +1;
				
				$this.data('clickcount',clickCount)	;
				showEventMessage.call(this, {eventType: '' + clickCount+ ')' + event.type});
				
				if (clickCount == 3)
					$this.trigger('click3');
				// here event is triggered by function(event) while .data refers to internalObject
				if ($this.attr('type') === 'button')
					var theObject = event.data || {records: []};
					$('#Messages').append('Record count: ' + theObject.records.length + '<br/>');
					loadRecord();
			})
			.on('click3', function(event){
				event.stopPropagation();
				showEventMessage.call(this, {eventType: event.type});
				$(this).addClass('highlight');
			});
		$(notifyObject)
			.on('recordsloaded', function(event, theObject){
				showEventMessage.call(this, {eventType: event.type});
				$.each(theObject.records, function(){
					$('#Messages').append(' -- ' + this.description + ': ' + this.value + '<br/>');})
			})
			
		});
	</script>
<html>